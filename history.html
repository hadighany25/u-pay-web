<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction History - U-Pay</title>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />

    <style>
      /* --- BASE STYLES --- */
      body {
        background-color: #f2f4f6;
        margin: 0;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        font-family: "Inter", "Kantumruy Pro", sans-serif;
      }
      .app-container {
        width: 100%;
        max-width: 450px;
        background: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        padding-bottom: 90px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.05);
      }

      /* HEADER */
      .nav-header {
        padding: 20px;
        background: #004d40;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 1.1rem;
        position: sticky;
        top: 0;
        z-index: 50;
      }
      .nav-header a {
        color: white;
        text-decoration: none;
      }

      /* EXPORT & FILTER TOOLBAR */
      .tool-bar {
        padding: 15px 20px;
        background: #f8fafc;
        border-bottom: 1px solid #eee;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: sticky;
        top: 60px;
        z-index: 40;
      }
      .date-inputs {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .date-inputs input {
        flex: 1;
        padding: 10px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.85rem;
        outline: none;
      }
      .export-btn {
        background: #004d40;
        color: white;
        border: none;
        padding: 12px 15px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        transition: 0.2s;
        justify-content: center;
      }
      .export-btn:active {
        transform: scale(0.98);
      }

      /* LIST */
      .history-list {
        padding: 10px 20px;
        flex: 1;
        overflow-y: auto;
      }
      .date-label {
        font-size: 0.8rem;
        font-weight: 700;
        color: #94a3b8;
        margin: 20px 0 10px 0;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .trx-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: white;
        border-radius: 16px;
        margin-bottom: 10px;
        cursor: pointer;
        border: 1px solid #f1f5f9;
        transition: 0.2s;
      }
      .trx-item:active {
        transform: scale(0.98);
        background: #f8fafc;
      }

      .trx-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .trx-icon {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      .trx-info h4 {
        margin: 0;
        font-size: 0.95rem;
        color: #1e293b;
        font-weight: 600;
      }
      .trx-info p {
        margin: 4px 0 0 0;
        font-size: 0.75rem;
        color: #94a3b8;
      }
      .trx-amount {
        font-weight: 700;
        font-size: 1rem;
      }

      .text-green {
        color: #059669;
      }
      .text-red {
        color: #dc2626;
      }
      .bg-green {
        background: #d1fae5;
        color: #059669;
      }
      .bg-red {
        background: #fee2e2;
        color: #dc2626;
      }
      .bg-blue {
        background: #e0f2fe;
        color: #0284c7;
      }

      /* BOTTOM NAV */
      .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 450px;
        background: white;
        padding: 12px 0 20px 0;
        display: flex;
        justify-content: space-around;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        z-index: 1000;
        border-radius: 25px 25px 0 0;
      }
      .nav-item {
        text-align: center;
        color: #94a3b8;
        font-size: 0.75rem;
        text-decoration: none;
        cursor: pointer;
        flex: 1;
      }
      .nav-item i {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 6px;
      }
      .nav-item.active {
        color: #004d40;
        font-weight: 700;
      }

      /* SLIP MODAL */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .slip-container {
        width: 340px;
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        animation: slideUp 0.3s ease-out;
      }
      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .slip-header {
        background: #004d40;
        padding: 25px 20px 30px;
        text-align: center;
        color: white;
      }
      .slip-status-icon {
        width: 60px;
        height: 60px;
        background: white;
        color: #004d40;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 10px;
      }
      .slip-amount {
        font-size: 2.2rem;
        font-weight: 800;
        margin-top: 10px;
      }
      .slip-body {
        padding: 20px 25px;
        color: #333;
        background: white;
      }
      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
      .d-label {
        color: #888;
      }
      .d-value {
        font-weight: 700;
        text-align: right;
        color: #1e293b;
        max-width: 60%;
        word-break: break-word;
      }
      .d-mono {
        font-family: monospace;
        color: #004d40;
        font-weight: bold;
      }
      .dashed-line {
        border-top: 2px dashed #ddd;
        margin: 15px -25px;
      }
      .slip-footer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 15px;
      }
      .qr-box {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8fafc;
        padding: 5px 10px;
        border-radius: 8px;
        border: 1px solid #eee;
      }
      .slip-actions {
        display: flex;
        justify-content: center;
        gap: 40px;
        padding: 20px;
        background: white;
        border-top: 1px solid #f0f0f0;
      }
      .action-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: #004d40;
        background: #f0fdf4;
        border-color: #004d40;
      }
      .action-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #004d40;
        cursor: pointer;
      }

      /* Dark Mode */
      body.dark-mode {
        background: #000;
      }
      body.dark-mode .app-container {
        background: #121212;
        color: white;
      }
      body.dark-mode .tool-bar {
        background: #1e1e1e;
        border-color: #333;
      }
      body.dark-mode .date-inputs input {
        background: #2d2d2d;
        color: white;
        border-color: #444;
      }
      body.dark-mode .trx-item {
        background: #1e1e1e;
        border-color: #333;
      }
      body.dark-mode .trx-info h4 {
        color: white;
      }
      body.dark-mode .bottom-nav {
        background: #1e1e1e;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="nav-header">
        <div style="display: flex; align-items: center; gap: 15px">
          <a href="dashboard.html"><i class="fa-solid fa-arrow-left"></i></a>
          <span>History</span>
        </div>
      </div>

      <div class="tool-bar">
        <div class="date-inputs">
          <input type="date" id="startDate" title="Start Date" />
          <span style="color: #94a3b8">to</span>
          <input type="date" id="endDate" title="End Date" />
        </div>
        <button class="export-btn" onclick="exportStatementPDF()">
          <i class="fa-solid fa-file-pdf"></i> Export Statement
        </button>
      </div>

      <div class="history-list" id="historyList">
        <p style="text-align: center; color: #94a3b8; margin-top: 50px">
          Loading...
        </p>
      </div>

      <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item"
          ><i class="fa-solid fa-house"></i> Home</a
        >
        <a href="scan.html" class="nav-item"
          ><i class="fa-solid fa-qrcode"></i> Scan</a
        >
        <a href="#" class="nav-item active"
          ><i class="fa-solid fa-clock-rotate-left"></i> History</a
        >
        <a href="settings.html" class="nav-item"
          ><i class="fa-solid fa-gear"></i> Settings</a
        >
      </div>
    </div>

    <div id="slipModal" class="modal-overlay">
      <div id="captureArea" class="slip-container">
        <div class="slip-header">
          <div class="slip-status-icon"><i class="fa-solid fa-check"></i></div>
          <div class="slip-title" id="slipModalTitle">Transaction Details</div>
          <div class="slip-amount" id="slipAmount">$0.00</div>
        </div>
        <div class="slip-body">
          <div class="detail-row">
            <span class="d-label">Ref ID</span
            ><span class="d-value d-mono" id="slipRef">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Date</span
            ><span class="d-value" id="slipDate">...</span>
          </div>
          <div class="dashed-line"></div>
          <div class="detail-row">
            <span class="d-label">From</span
            ><span class="d-value" id="slipSender">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">To</span
            ><span class="d-value" id="slipReceiver">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Method</span
            ><span class="d-value" id="slipMethod">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Remark</span
            ><span class="d-value" id="slipRemark">...</span>
          </div>

          <div class="slip-footer-info">
            <div class="qr-box">
              <img
                src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Verify"
                style="width: 40px; height: 40px"
              />
              <div
                style="
                  font-size: 0.65rem;
                  font-weight: 800;
                  color: #004d40;
                  line-height: 1.1;
                "
              >
                <span>SCAN TO</span><br /><span>VERIFY</span>
              </div>
            </div>
            <img src="images/logo.png" style="width: 70px; opacity: 0.9" />
          </div>
        </div>
        <div class="slip-actions">
          <div class="action-item" onclick="saveSlipImage()">
            <div class="action-circle">
              <i class="fa-solid fa-download"></i>
            </div>
            <span>Save</span>
          </div>
          <div
            class="action-item"
            onclick="
              document.getElementById('slipModal').style.display = 'none'
            "
          >
            <div class="action-circle"><i class="fa-solid fa-xmark"></i></div>
            <span>Close</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) window.location.href = "index.html";
      let currentTransactions = [];

      // Dark Mode Config
      if (localStorage.getItem("darkMode") === "true")
        document.body.classList.add("dark-mode");

      // Set default dates to current month
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      document.getElementById("startDate").value = firstDay
        .toISOString()
        .split("T")[0];
      document.getElementById("endDate").value = today
        .toISOString()
        .split("T")[0];

      // Format currency with commas
      function formatMoney(amount) {
        return Math.abs(amount).toLocaleString("en-US", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      // Load History List UI
      function loadHistory() {
        const list = document.getElementById("historyList");
        list.innerHTML = "";

        if (!user.transactions || user.transactions.length === 0) {
          list.innerHTML =
            '<div style="text-align:center; color:#ccc; margin-top:50px"><p>No transactions found</p></div>';
          return;
        }

        // Sort newest first for UI
        let filtered = user.transactions.slice().reverse();
        currentTransactions = filtered;

        let lastDate = "";
        filtered.forEach((t, index) => {
          const isIncome = t.amount > 0;
          let iconClass = isIncome ? "fa-arrow-down" : "fa-arrow-up";
          let bgClass = isIncome ? "bg-green" : "bg-red";
          if (t.type === "Bill Payment") {
            iconClass = "fa-file-invoice-dollar";
            bgClass = "bg-blue";
          }

          let dateLabel = t.date ? t.date.split(",")[0] : "Recent";
          if (dateLabel !== lastDate) {
            let displayLabel =
              dateLabel === new Date().toLocaleDateString("en-US")
                ? "Today"
                : dateLabel;
            list.innerHTML += `<div class="date-label">${displayLabel}</div>`;
            lastDate = dateLabel;
          }

          const item = document.createElement("div");
          item.className = "trx-item";
          item.onclick = function () {
            showSlip(index);
          };

          let title = t.type;
          if (t.type === "Transfer")
            title = isIncome
              ? t.senderName || "Sender"
              : t.receiverName || "Receiver";
          else if (t.type === "Bill Payment") title = t.receiverName || "Bill";

          item.innerHTML = `
                <div class="trx-left">
                    <div class="trx-icon ${bgClass}"><i class="fa-solid ${iconClass} ${isIncome ? "text-green" : "text-red"}"></i></div>
                    <div class="trx-info">
                        <h4>${title}</h4>
                        <p>${t.date ? t.date.split(", ")[1] : ""} â€¢ ${t.trxMethod || "U-Pay"}</p>
                    </div>
                </div>
                <div class="trx-amount ${isIncome ? "text-green" : "text-red"}">
                    ${isIncome ? "+" : ""}$${formatMoney(t.amount)}
                </div>
            `;
          list.appendChild(item);
        });
      }

      function showSlip(index) {
        const t = currentTransactions[index];
        if (!t) return;
        const isSender = t.amount < 0;

        document.getElementById("slipModalTitle").innerText =
          t.type === "Bill Payment"
            ? "Payment Receipt"
            : isSender
              ? "Transfer Sent"
              : "Transfer Received";
        document.getElementById("slipAmount").innerText =
          "$" + formatMoney(t.amount);
        document.getElementById("slipRef").innerText = t.refId || "N/A";
        document.getElementById("slipDate").innerText = t.date;
        document.getElementById("slipSender").innerText =
          t.senderName || user.username;
        document.getElementById("slipReceiver").innerText =
          t.receiverName || t.partner || "Unknown";
        document.getElementById("slipMethod").innerText =
          t.trxMethod || "U-Pay App";
        document.getElementById("slipRemark").innerText = t.remark || "-";

        document.getElementById("slipModal").style.display = "flex";
      }

      function saveSlipImage() {
        document.querySelector(".slip-actions").style.display = "none";
        html2canvas(document.getElementById("captureArea")).then((canvas) => {
          const link = document.createElement("a");
          link.download = `Slip-${Date.now()}.png`;
          link.href = canvas.toDataURL();
          link.click();
          document.querySelector(".slip-actions").style.display = "flex";
        });
      }

      // ðŸ”¥ EXPORT REAL MULTI-PAGE PDF (ABA STYLE WITH LOGO IMAGE)
      function exportStatementPDF() {
        const startDateStr = document.getElementById("startDate").value;
        const endDateStr = document.getElementById("endDate").value;
        if (!startDateStr || !endDateStr)
          return Swal.fire("Warning", "Please select date range", "warning");

        const start = new Date(startDateStr);
        start.setHours(0, 0, 0, 0);
        const end = new Date(endDateStr);
        end.setHours(23, 59, 59, 999);

        Swal.fire({
          title: "Generating PDF...",
          didOpen: () => Swal.showLoading(),
        });

        // 1. Pre-load Logo Image
        const logoImg = new Image();
        // ðŸ”¥ áž”áŸ’ážšáž¾ážšáž¼áž” logo.png (áž¬ logo-nobg.png áž”áž¾áž”áž„áž˜áž¶áž“)
        logoImg.src = "images/logo.png";

        logoImg.onload = function () {
          // 2. Calculate Data
          let openingBalance = 0;
          let totalIn = 0;
          let totalOut = 0;
          const allTrx = (user.transactions || [])
            .slice()
            .sort((a, b) => new Date(a.date) - new Date(b.date));
          const stTrx = [];
          let runningBalance = 0;

          allTrx.forEach((t) => {
            const tDate = new Date(t.date);
            runningBalance += t.amount;
            if (tDate < start) openingBalance = runningBalance;
            else if (tDate >= start && tDate <= end) {
              stTrx.push({ ...t, currentBalance: runningBalance });
              if (t.amount > 0) totalIn += t.amount;
              else totalOut += Math.abs(t.amount);
            }
          });

          if (stTrx.length === 0) {
            Swal.close();
            return Swal.fire(
              "Notice",
              "No transactions found in this period.",
              "info",
            );
          }
          const endingBalance = openingBalance + totalIn - totalOut;

          // 3. Initialize jsPDF
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF("p", "pt", "a4");
          const pageWidth = doc.internal.pageSize.getWidth();

          // --- DRAW HEADER FUNCTION (WITH IMAGE LOGO) ---
          function drawHeader(doc) {
            // ðŸ”¥ ážŠáž¶áž€áŸ‹ážšáž¼áž” Logo áž‡áŸ†áž“áž½ážŸáž”áŸ’ážšáž¢áž”áŸ‹áž”áŸƒážáž„
            // (x=40, y=40, width=80, height=40 -> áž›áŸƒážáž˜áŸ’ážšáž¼ážœážáž¶áž˜áž…áž·ážáŸ’áž)
            doc.addImage(logoImg, "PNG", 40, 40, 80, 40);

            // Right side Header
            doc.setTextColor(30, 41, 59);
            doc.setFont("helvetica", "bold");
            doc.setFontSize(20);
            doc.text("ACCOUNT STATEMENT", pageWidth - 40, 55, {
              align: "right",
            });
            doc.setFontSize(10);
            doc.setTextColor(0, 77, 64);
            doc.text(
              `For period: ${start.toLocaleDateString("en-US", { month: "short", day: "2-digit", year: "numeric" })} - ${end.toLocaleDateString("en-US", { month: "short", day: "2-digit", year: "numeric" })}`,
              pageWidth - 40,
              70,
              { align: "right" },
            );

            doc.setDrawColor(0, 77, 64);
            doc.setLineWidth(1.5);
            doc.line(40, 90, pageWidth - 40, 90);
          }

          drawHeader(doc);

          // --- DRAW USER INFO & SUMMARY ---
          doc.setTextColor(30, 41, 59);
          doc.setFont("helvetica", "bold");
          doc.setFontSize(10);
          doc.text((user.fullName || user.username).toUpperCase(), 40, 115);
          doc.setFont("helvetica", "normal");
          doc.text("Phnom Penh, Cambodia", 40, 130);

          const midX = pageWidth / 2 + 20;
          doc.setFont("helvetica", "bold");
          doc.text("ACCOUNT DETAILS", midX, 115);
          doc.setFontSize(9);
          doc.setFont("helvetica", "normal");
          doc.text("Account Name", midX, 130);
          doc.text(
            (user.fullName || user.username).toUpperCase(),
            pageWidth - 40,
            130,
            { align: "right" },
          );
          doc.text("Account Type", midX, 145);
          doc.text("Savings", pageWidth - 40, 145, { align: "right" });
          doc.text("Account No.", midX, 160);
          doc.text(
            user.accountNumber.replace(/(\d{3})(\d{3})(\d{3})/, "$1 $2 $3"),
            pageWidth - 40,
            160,
            { align: "right" },
          );
          doc.text("Currency", midX, 175);
          doc.text("USD", pageWidth - 40, 175, { align: "right" });

          doc.setFont("helvetica", "bold");
          doc.setFontSize(10);
          doc.text("ACCOUNT SUMMARY", midX, 205);
          doc.setFontSize(9);
          doc.setFont("helvetica", "normal");
          doc.text("Opening Balance", midX, 220);
          doc.text(`${formatMoney(openingBalance)} USD`, pageWidth - 40, 220, {
            align: "right",
          });
          doc.text("Total Money In", midX, 235);
          doc.text(`+ ${formatMoney(totalIn)} USD`, pageWidth - 40, 235, {
            align: "right",
          });
          doc.text("Total Money Out", midX, 250);
          doc.text(`- ${formatMoney(totalOut)} USD`, pageWidth - 40, 250, {
            align: "right",
          });
          doc.setFont("helvetica", "bold");
          doc.text("Ending Balance", midX, 265);
          doc.text(`${formatMoney(endingBalance)} USD`, pageWidth - 40, 265, {
            align: "right",
          });

          doc.text("ACCOUNT ACTIVITY", 40, 310);

          // --- PREPARE & GENERATE TABLE ---
          const tableBody = stTrx.map((t) => {
            const isIncome = t.amount > 0;
            let details = `${t.type.toUpperCase()}`;
            if (t.type === "Transfer")
              details += isIncome
                ? ` FROM ${t.senderName}`
                : ` TO ${t.receiverName}`;
            else details += ` TO ${t.receiverName || "BILL"}`;
            details += `\nREF# ${t.refId || "N/A"}`;
            if (t.remark) details += `\nREMARK: ${t.remark}`;
            return [
              t.date.split(",")[0] + "\n" + (t.date.split(",")[1] || "").trim(),
              details,
              isIncome ? formatMoney(t.amount) + " USD" : "",
              !isIncome ? formatMoney(t.amount) + " USD" : "",
              formatMoney(t.currentBalance) + " USD",
            ];
          });

          doc.autoTable({
            startY: 320,
            head: [
              [
                "Date",
                "Transaction Details",
                { content: "Money In", styles: { halign: "right" } },
                { content: "Money Out", styles: { halign: "right" } },
                { content: "Balance", styles: { halign: "right" } },
              ],
            ],
            margin: { bottom: 60 }, // áž‘áž»áž€áž‚áž˜áŸ’áž›áž¶ážážáž¶áž„áž€áŸ’ážšáŸ„áž˜áž±áŸ’áž™áž’áŸ† áž€áž»áŸ†áž±áŸ’áž™ážáž¶ážšáž¶áž„áž‡áž·ážáž¢áž€áŸ’ážŸážš Page áž–áŸáž€
            rowPageBreak: "avoid", // áž”áž¾áž”áž“áŸ’áž‘áž¶ážáŸ‹áž áŸ’áž“áž¹áž„ážœáŸ‚áž„áž’áŸ’áž›áž¶áž€áŸ‹ážŠáž›áŸ‹áž€áŸ’ážšáŸ„áž˜ áž±áŸ’áž™ážœáž¶ážšáž»áž‰áž‘áŸ…áž‘áŸ†áž–áŸážšážáŸ’áž˜áž¸áž‘áž¶áŸ†áž„áž˜áž¼áž›ážáŸ‚áž˜áŸ’ážŠáž„ áž€áž»áŸ†áž±áŸ’áž™ážŠáž¶áž…áŸ‹áž–áž¶áž€áŸ‹áž€ážŽáŸ’ážŠáž¶áž›
            body: tableBody,
            theme: "plain",
            styles: { fontSize: 8, textColor: [50, 50, 50], cellPadding: 8 },
            headStyles: {
              fontStyle: "bold",
              borderBottomColor: [0, 0, 0],
              borderBottomWidth: 1.5,
              textColor: [0, 0, 0],
            },
            bodyStyles: {
              borderBottomColor: [220, 220, 220],
              borderBottomWidth: 0.5,
            },
            columnStyles: {
              0: { cellWidth: 70 },
              1: { cellWidth: "auto" },
              2: { halign: "right", cellWidth: 70 },
              3: { halign: "right", cellWidth: 70 },
              4: { halign: "right", cellWidth: 70 },
            },
            didDrawPage: function (data) {
              doc.setFontSize(8);
              doc.setTextColor(150, 150, 150);
              doc.text(
                "U-Pay Plc. | +855 98 203 203 | info@upay.com",
                40,
                doc.internal.pageSize.height - 30,
              );
              doc.text(
                "Page " + doc.internal.getNumberOfPages(),
                pageWidth - 40,
                doc.internal.pageSize.height - 30,
                { align: "right" },
              );
            },
          });

          // --- LAST PAGE SUMMARY ---
          let finalY = doc.lastAutoTable.finalY + 30;
          if (finalY > doc.internal.pageSize.height - 150) {
            doc.addPage();
            finalY = 50;
          }
          doc.setFont("helvetica", "bold");
          doc.setFontSize(9);
          doc.text("Ending Balance", 40, finalY);
          doc.text(
            `${formatMoney(endingBalance)} USD`,
            pageWidth - 40,
            finalY,
            { align: "right" },
          );
          doc.setDrawColor(0, 0, 0);
          doc.line(40, finalY + 10, pageWidth - 40, finalY + 10);
          doc.text("Total", 40, finalY + 25);
          doc.text(
            `${formatMoney(totalIn)} USD`,
            pageWidth - 110,
            finalY + 25,
            { align: "right" },
          );
          doc.text(
            `${formatMoney(totalOut)} USD`,
            pageWidth - 40,
            finalY + 25,
            { align: "right" },
          );
          doc.line(40, finalY + 35, pageWidth - 40, finalY + 35);
          doc.setFont("helvetica", "normal");
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(
            "The Ending Balance does not reflect any pending withdrawals or holds on deposited funds that may have been outstanding on your account when your transactions posted.\n\nDISCLAIMER: This document is for informational purpose only and cannot be used as an official proof of financial statement unless affirmed by the bank representative with seal and signature. U-Pay Plc. does not guarantee that this information is error-free or omission-free, and customer is required to contact the bank shall any content verification be required. U-Pay Plc. is not responsible for any losses or damages whether direct or indirect, which may arise from use of this information (document).",
            40,
            finalY + 55,
            { maxWidth: pageWidth - 80, lineHeightFactor: 1.5 },
          );

          doc.save(`Statement_${user.username}_${startDateStr}.pdf`);
          Swal.close();
        }; // end logoImg.onload

        logoImg.onerror = function () {
          Swal.close();
          Swal.fire("Error", "Cannot load logo image for PDF.", "error");
        };
      }

      loadHistory();
    </script>
  </body>
</html>
