<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - U-Pay</title>

    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Kantumruy+Pro:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="js/lang.js"></script>

    <style>
      /* BASE STYLES */
      body {
        background-color: #f2f4f6;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        min-height: 100vh;
        font-family: "Inter", "Kantumruy Pro", sans-serif;
      }
      .kh-font * {
        font-family: "Kantumruy Pro", sans-serif !important;
      }
      .app-container {
        width: 100%;
        max-width: 480px;
        background: white;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        position: relative;
        padding-bottom: 90px; /* For bottom nav spacing */
      }

      /* HEADER */
      .header {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
      }
      .user-profile {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .avatar {
        width: 50px;
        height: 50px;
        background: #e0f2f1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #004d40;
        font-size: 1.5rem;
        overflow: hidden;
        border: 2px solid #e0f2f1;
      }
      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .greeting h4 {
        margin: 0;
        color: #888;
        font-size: 0.9rem;
        font-weight: normal;
      }
      .greeting h2 {
        margin: 0;
        color: #333;
        font-size: 1.2rem;
        font-weight: 700;
      }
      .refresh-btn {
        background: #e0f2f1;
        color: #004d40;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
      }
      .refresh-btn:active {
        transform: rotate(180deg);
      }

      /* CREDIT CARD */
      .credit-card {
        margin: 10px 20px 20px 20px;
        border-radius: 20px;
        padding: 25px;
        color: #333;
        position: relative;
        height: 210px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start;
        z-index: 1;
      }
      .credit-card::before {
        content: "";
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        background: linear-gradient(60deg, #004d40, #ffd700, #00b894, #004d40);
        background-size: 300% 300%;
        z-index: -2;
        border-radius: 24px;
        animation: border-run 3s linear infinite;
      }
      .credit-card::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        z-index: -1;
        border-radius: 20px;
      }
      @keyframes border-run {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .card-top {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }
      .card-chip {
        width: 50px;
        height: 35px;
        background: linear-gradient(
          135deg,
          #d4af37 0%,
          #fbe89e 50%,
          #d4af37 100%
        );
        border-radius: 6px;
        border: 1px solid #b8860b;
      }
      .card-logo-img {
        height: 50px;
        width: auto;
        object-fit: contain;
      }
      .card-body {
        margin-top: -15px;
        width: 100%;
      }
      .card-label {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 5px;
      }
      .card-balance {
        font-size: 2.2rem;
        font-weight: bold;
        color: #000;
        margin: 0;
      }
      .card-footer {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
      }
      .card-number {
        font-family: monospace;
        font-size: 1.1rem;
        letter-spacing: 2px;
        color: #555;
      }
      .visa-logo-img {
        height: 22px;
        width: auto;
        opacity: 0.8;
      }

      /* MENU */
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        padding: 10px 20px 25px 20px;
      }
      .menu-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        background: none;
        border: none;
        cursor: pointer;
      }
      .icon-box {
        width: 55px;
        height: 55px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        transition: 0.2s;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }
      .menu-text {
        font-size: 0.8rem;
        color: #555;
        font-weight: 600;
      }
      .icon-transfer {
        background: #e0f2f1;
        color: #004d40;
      }
      .icon-scan {
        background: #e3f2fd;
        color: #1565c0;
      }
      .icon-payment {
        background: #fff3e0;
        color: #e65100;
      }
      .icon-setting {
        background: #f3e5f5;
        color: #7b1fa2;
      }

      /* TRANSACTIONS */
      .recent-section {
        flex: 1;
        background: white;
        padding: 0 20px 20px 20px;
        overflow-y: auto;
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.02);
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        margin-top: 20px;
      }
      .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #333;
      }
      .trx-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 15px;
        margin-bottom: 10px;
        cursor: pointer;
      }
      .trx-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .trx-icon {
        width: 45px;
        height: 45px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
      }
      .trx-info h4 {
        margin: 0;
        font-size: 0.95rem;
        color: #333;
      }
      .trx-info p {
        margin: 3px 0 0 0;
        font-size: 0.8rem;
        color: #888;
      }
      .trx-amount {
        font-weight: bold;
        font-size: 1rem;
      }
      .text-green {
        color: #00b894;
      }
      .text-red {
        color: #e74c3c;
      }
      .bg-green {
        background: #e0f2f1;
        color: #004d40;
      }
      .bg-red {
        background: #fee2e2;
        color: #e74c3c;
      }

      /* üî• SLIP MODAL (PERFECTED) */
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 9999;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        overflow-y: auto;
        padding: 20px 0;
      }
      .slip-container {
        width: 340px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        animation: slideUp 0.4s ease-out;
      }
      @keyframes slideUp {
        from {
          transform: translateY(50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .slip-header {
        background: #004d40;
        padding: 25px 20px 30px;
        text-align: center;
        color: white;
        position: relative;
      }
      .slip-status-icon {
        width: 60px;
        height: 60px;
        background: white;
        color: #004d40;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .slip-title {
        font-weight: 600;
        font-size: 1.1rem;
        margin-top: 5px;
      }
      .slip-amount {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 5px 0 0;
        letter-spacing: -1px;
      }
      .slip-currency {
        font-size: 1rem;
        font-weight: normal;
        opacity: 0.8;
      }

      .slip-body {
        padding: 20px 25px;
        background: white;
        position: relative;
      }

      .dashed-line {
        margin: 15px -25px;
        border-top: 2px dashed #ddd;
        position: relative;
      }
      .dashed-line::before,
      .dashed-line::after {
        content: "";
        position: absolute;
        top: -10px;
        width: 20px;
        height: 20px;
        background: rgba(0, 0, 0, 0.85);
        border-radius: 50%;
      }
      .dashed-line::before {
        left: -10px;
      }
      .dashed-line::after {
        right: -10px;
      }

      .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
        font-size: 0.9rem;
      }
      .d-label {
        color: #888;
        font-weight: 500;
      }
      .d-value {
        font-weight: 700;
        color: #1f2937;
        text-align: right;
        max-width: 60%;
        word-break: break-word;
      }
      .d-mono {
        font-family: "Courier New", monospace;
        letter-spacing: 0.5px;
        color: #004d40;
        font-weight: bold;
      }

      /* QR & Logo Footer */
      .slip-footer-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 10px;
      }
      .qr-box {
        display: flex;
        align-items: center;
        gap: 10px;
        border: 1px solid #eee;
        padding: 5px 10px;
        border-radius: 10px;
        background: #f9fafb;
      }
      .qr-img {
        width: 45px;
        height: 45px;
      }
      .qr-text {
        font-size: 0.7rem;
        font-weight: 800;
        color: #004d40;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
      }
      .footer-logo {
        width: 80px;
      }

      /* ACTIONS */
      .slip-actions {
        display: flex;
        justify-content: center;
        gap: 40px;
        padding: 25px;
        background: #fff;
        border-top: 1px solid #f0f0f0;
      }
      .action-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: 0.2s;
        color: #004d40;
      }
      .action-item:hover {
        opacity: 0.8;
        transform: translateY(-2px);
      }
      .action-circle {
        width: 55px;
        height: 55px;
        border-radius: 50%;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        background: #fff;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        color: #004d40;
      }
      .action-text {
        font-size: 0.85rem;
        font-weight: 600;
      }
      .action-circle.done {
        background: #f0fdf4;
        border-color: #004d40;
      }

      /* üî• BOTTOM NAV STYLES (·ûê·üÇ·ûò·ûê·üí·ûò·û∏) */
      .bottom-nav {
        position: fixed;
        bottom: 0;

        /* üî• ·ûÄ·üÇ·ûè·üí·ûö·ûÑ·üã·ûì·üÅ·üá (·ûä·û∂·ûÄ·üã·ûÄ·ûº·ûä·ûë·û∂·üÜ·ûÑ·ûä·ûª·üÜ·ûì·üÅ·üá·ûá·üÜ·ûì·ûΩ·ûü·ûö·ûî·ûü·üã·ûÖ·û∂·ûü·üã) */
        left: 50%;
        transform: translateX(-50%); /* ·û±·üí·ûô·ûì·üÖ·ûÄ·ûé·üí·ûè·û∂·ûõ·û¢·üÅ·ûÄ·üí·ûö·ûÑ·üã */
        width: 100%;
        max-width: 480px; /* ·û±·üí·ûô·ûî·üâ·ûª·ûì·ûÇ·üí·ûì·û∂·ûá·û∂·ûò·ûΩ·ûô·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë */
        display: flex; /* ·ûî·ûÑ·üí·û†·û∂·ûâ·ûá·û∂·ûì·û∑·ûÖ·üí·ûÖ (·ûÄ·ûª·üÜ·ûä·û∂·ûÄ·üã none) */

        background: white;
        padding: 12px 0 15px 0;
        justify-content: space-around;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        z-index: 9999;
        border-radius: 20px 20px 0 0;
      }

      .nav-item {
        text-align: center;
        color: #94a3b8;
        font-size: 0.75rem;
        text-decoration: none;
        cursor: pointer;
        transition: 0.2s;
      }

      .nav-item i {
        font-size: 1.4rem;
        display: block;
        margin-bottom: 5px;
      }

      .nav-item.active {
        color: #004d40;
        font-weight: 700;
        transform: translateY(-5px);
      }

      /* Dark Mode Support */
      body.dark-mode .bottom-nav {
        background: #1e1e1e;
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.3);
      }
      body.dark-mode .nav-item.active {
        color: #10b981;
      }

      /* üî• SHOW ON MOBILE (·ûî·ûÑ·üí·û†·û∂·ûâ·ûè·üÇ·ûñ·üÅ·ûõ·û¢·üÅ·ûÄ·üí·ûö·ûÑ·üã·ûè·ûº·ûÖ) */
      @media (max-width: 768px) {
        .bottom-nav {
          display: flex; /* ·ûî·ûÑ·üí·û†·û∂·ûâ Nav */
        }
        .sidebar {
          display: none; /* ·ûõ·û∂·ûÄ·üã Sidebar ·ûÖ·üÑ·ûõ */
        }
        /* ·ûë·ûª·ûÄ·ûÇ·ûò·üí·ûõ·û∂·ûè·ûÅ·û∂·ûÑ·ûÄ·üí·ûö·üÑ·ûò ·ûÄ·ûª·üÜ·û±·üí·ûô Nav ·ûî·û∂·üÜ·ûÑ·û¢·ûÄ·üí·ûü·ûö */
        .app-container,
        .main-content {
          padding-bottom: 80px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <div class="header">
        <div class="user-profile">
          <div class="avatar" id="avatarBox">
            <i class="fa-solid fa-user"></i>
          </div>
          <div class="greeting">
            <h4 data-i18n="greeting_morning">Welcome back,</h4>
            <h2 id="username">...</h2>
          </div>
        </div>
        <button class="refresh-btn" onclick="manualRefresh()">
          <i class="fa-solid fa-rotate-right"></i>
        </button>
      </div>

      <div class="credit-card">
        <div class="card-top">
          <span class="card-chip"></span
          ><img src="images/logo-nobg.png" class="card-logo-img" />
        </div>
        <div class="card-body">
          <p class="card-label" data-i18n="total_balance">Total Balance</p>
          <h1 class="card-balance">$<span id="balance">0.00</span></h1>
        </div>
        <div class="card-footer">
          <p class="card-number" id="accNum">....</p>
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/2560px-Visa_Inc._logo.svg.png"
            class="visa-logo-img"
          />
        </div>
      </div>

      <div class="menu-grid">
        <button
          class="menu-item"
          onclick="window.location.href = 'transfer.html'"
        >
          <div class="icon-box icon-transfer">
            <i class="fa-solid fa-paper-plane"></i>
          </div>
          <span class="menu-text" data-i18n="btn_transfer">Transfer</span>
        </button>
        <button class="menu-item" onclick="window.location.href = 'scan.html'">
          <div class="icon-box icon-scan">
            <i class="fa-solid fa-qrcode"></i>
          </div>
          <span class="menu-text" data-i18n="btn_scan">Scan QR</span>
        </button>
        <button
          class="menu-item"
          onclick="window.location.href = 'payment.html'"
        >
          <div class="icon-box icon-payment">
            <i class="fa-solid fa-file-invoice-dollar"></i>
          </div>
          <span class="menu-text" data-i18n="btn_payment">Payment</span>
        </button>
        <button
          class="menu-item"
          onclick="window.location.href = 'settings.html'"
        >
          <div class="icon-box icon-setting">
            <i class="fa-solid fa-gear"></i>
          </div>
          <span class="menu-text" data-i18n="btn_settings">Settings</span>
        </button>
      </div>

      <div class="recent-section">
        <div class="section-header">
          <div class="section-title" data-i18n="recent_trx">
            Recent Transactions
          </div>
        </div>
        <div id="trxList">
          <p style="text-align: center; color: #ccc; margin-top: 30px">
            No transactions yet.
          </p>
        </div>
      </div>
    </div>

    <div id="slipModal" class="modal-overlay">
      <div id="captureArea" class="slip-container">
        <div class="slip-header">
          <div class="slip-status-icon"><i class="fa-solid fa-check"></i></div>
          <div class="slip-title" id="slipTitle">Transfer Successful</div>
          <div class="slip-amount" id="slipAmount">$0.00</div>
        </div>

        <div class="slip-body">
          <div class="detail-row">
            <span class="d-label">Trx ID</span>
            <span class="d-value d-mono" id="slipRef">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Hash</span>
            <span class="d-value d-mono" id="slipHash" style="font-size: 0.8rem"
              >...</span
            >
          </div>

          <div class="dashed-line"></div>

          <div class="detail-row">
            <span class="d-label">From</span>
            <span class="d-value" id="slipSenderName">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">To</span>
            <span class="d-value" id="slipReceiverName">...</span>
          </div>

          <div class="detail-row">
            <span class="d-label">Payment Via</span>
            <span class="d-value" id="slipMethod">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Date</span>
            <span class="d-value" id="slipDate">...</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Fee</span>
            <span class="d-value">$0.00</span>
          </div>
          <div class="detail-row">
            <span class="d-label">Remark</span>
            <span class="d-value" id="slipRemark">...</span>
          </div>

          <div class="slip-footer-info">
            <div class="qr-box">
              <img
                src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Verify"
                class="qr-img"
              />
              <div class="qr-text">
                <span>SCAN TO</span>
                <span>CHECK</span>
              </div>
            </div>
            <img src="images/logo.png" class="footer-logo" />
          </div>
        </div>

        <div class="slip-actions">
          <div class="action-item" onclick="downloadSlip()">
            <div class="action-circle done">
              <i class="fa-solid fa-share-nodes"></i>
            </div>
            <span class="action-text">Share</span>
          </div>

          <div class="action-item" id="btnRepeat" onclick="">
            <div class="action-circle done">
              <i class="fa-solid fa-rotate-right"></i>
            </div>
            <span class="action-text" id="lblRepeat">Repeat</span>
          </div>

          <div
            class="action-item"
            onclick="
              document.getElementById('slipModal').style.display = 'none'
            "
          >
            <div class="action-circle done">
              <i class="fa-solid fa-xmark"></i>
            </div>
            <span class="action-text">Done</span>
          </div>
        </div>
      </div>
    </div>
    <div class="bottom-nav">
      <a href="dashboard.html" class="nav-item active">
        <i class="fa-solid fa-house"></i> Home
      </a>
      <a href="scan.html" class="nav-item">
        <i class="fa-solid fa-qrcode"></i> Scan
      </a>
      <a href="history.html" class="nav-item">
        <i class="fa-solid fa-clock-rotate-left"></i> History
      </a>
      <a href="settings.html" class="nav-item">
        <i class="fa-solid fa-gear"></i> Settings
      </a>
    </div>
    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) window.location.href = "index.html";

      let lastBalance = user.balance;

      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
        document.write(
          "<style>body { background-color: #121212 !important; color: white !important; } .app-container { background-color: #121212 !important; } .credit-card { z-index: 1; } .menu-item { background-color: #1e1e1e !important; color: white !important; border-color: #333 !important; } .recent-section { background-color: #1e1e1e !important; color: white !important; } .section-title { color: #ccc !important; } .trx-item { background-color: #2c2c2c !important; } .trx-info h4 { color: white !important; } .header { background-color: #121212 !important; } .greeting h2 { color: white !important; } .slip-container { background: #fff !important; } </style>",
        );
      }

      async function fetchUserData(isAuto = true) {
        try {
          const res = await fetch("/api/users");
          const users = await res.json();
          const myUser = users.find((u) => u.username === user.username);
          if (myUser) {
            if (isAuto && myUser.balance > lastBalance) {
              new Audio(
                "https://notificationsounds.com/storage/sounds/file-sounds-1148-juntos.mp3",
              )
                .play()
                .catch((e) => {});
              Swal.fire({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 4000,
                icon: "success",
                title: `Received +$${(myUser.balance - lastBalance).toFixed(2)}`,
              });
            }
            lastBalance = myUser.balance;
            localStorage.setItem("user", JSON.stringify(myUser));
            updateUI(myUser);
          }
        } catch (err) {}
      }

      function manualRefresh() {
        fetchUserData(false);
        const btn = document.querySelector(".refresh-btn i");
        btn.style.transition = "transform 0.5s";
        btn.style.transform = "rotate(360deg)";
        setTimeout(() => (btn.style.transform = "rotate(0deg)"), 500);
      }

      function setGreeting() {
        const hour = new Date().getHours();
        const greetElement = document.querySelector(".greeting h4");
        let message = "Welcome back,";
        if (hour >= 5 && hour < 12) message = "Good Morning,";
        else if (hour >= 12 && hour < 18) message = "Good Afternoon,";
        else message = "Good Evening,";
        greetElement.innerText = message;
      }

      function updateUI(currentUser) {
        setGreeting();
        document.getElementById("username").innerText =
          currentUser.fullName || currentUser.username;
        document.getElementById("balance").innerText =
          currentUser.balance.toFixed(2);
        document.getElementById("accNum").innerText =
          currentUser.accountNumber.replace(
            /(\d{3})(\d{3})(\d{3})/,
            "$1 $2 $3",
          );
        if (currentUser.profileImage)
          document.getElementById("avatarBox").innerHTML =
            `<img src="${currentUser.profileImage}" alt="Profile">`;

        const list = document.getElementById("trxList");
        if (currentUser.transactions && currentUser.transactions.length > 0) {
          list.innerHTML = "";
          // LIMIT 10
          currentUser.transactions.slice(0, 10).forEach((t) => {
            const isIncome = t.amount > 0;
            let iconClass = isIncome ? "fa-arrow-down" : "fa-arrow-up";
            if (t.type === "Bill Payment") iconClass = "fa-file-invoice-dollar";

            const item = document.createElement("div");
            item.className = "trx-item";
            item.onclick = function () {
              showProfessionalSlip(t);
            };

            item.innerHTML = `
                        <div class="trx-left">
                            <div class="trx-icon ${isIncome ? "bg-green" : "bg-red"}"><i class="fa-solid ${iconClass}"></i></div>
                            <div class="trx-info"><h4>${t.type}</h4><p>${t.date.split(",")[0]}</p></div>
                        </div>
                        <div class="trx-amount ${isIncome ? "text-green" : "text-red"}">${isIncome ? "+" : ""}$${Math.abs(t.amount).toFixed(2)}</div>
                    `;
            list.appendChild(item);
          });
        }
      }

      function showProfessionalSlip(t) {
        const isSender = t.amount < 0;

        document.getElementById("slipTitle").innerText =
          t.status === "Success"
            ? isSender
              ? "Transfer Successful"
              : "Received Successfully"
            : "Failed";
        document.getElementById("slipAmount").innerText =
          "$" + Math.abs(t.amount).toFixed(2);
        document.getElementById("slipDate").innerText = t.date;
        document.getElementById("slipRef").innerText = t.refId;
        document.getElementById("slipHash").innerText = t.hash || "N/A";
        document.getElementById("slipRemark").innerText = t.remark || "-";
        document.getElementById("slipSenderName").innerText =
          t.senderName || "Unknown";
        document.getElementById("slipReceiverName").innerText =
          t.receiverName || "Unknown";

        const btnRepeat = document.getElementById("btnRepeat");
        const lblRepeat = document.getElementById("lblRepeat");

        if (t.type === "Bill Payment") {
          lblRepeat.innerText = "Pay Again";
          btnRepeat.onclick = function () {
            window.location.href = `payment.html?billId=${t.billId}&amount=${Math.abs(t.amount)}`;
          };
        } else if (isSender) {
          lblRepeat.innerText = "Repeat";
          btnRepeat.onclick = function () {
            window.location.href = `transfer.html?acc=${t.receiverAcc}&amount=${Math.abs(t.amount)}`;
          };
        } else {
          lblRepeat.innerText = "Refund";
          btnRepeat.onclick = function () {
            window.location.href = `transfer.html?acc=${t.senderAcc}&amount=${Math.abs(t.amount)}`;
          };
        }
        // üî• ·ûî·ûÑ·üí·û†·û∂·ûâ Method (QR Scan ·û¨ Account Input)
        document.getElementById("slipMethod").innerText =
          t.trxMethod || "Account Input";
        document.getElementById("slipModal").style.display = "flex";
      }

      function downloadSlip() {
        // Hide footer actions before capture
        document.querySelector(".slip-actions").style.display = "none";
        html2canvas(document.getElementById("captureArea")).then((canvas) => {
          const link = document.createElement("a");
          link.download = "u-pay-receipt.png";
          link.href = canvas.toDataURL();
          link.click();
          // Show footer again
          document.querySelector(".slip-actions").style.display = "flex";
        });
      }

      setInterval(() => fetchUserData(true), 3000);
      setInterval(
        () =>
          fetch("/api/heartbeat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username: user.username }),
          }),
        5000,
      );
      updateUI(user);
      fetchUserData(false);
    </script>
  </body>
</html>
